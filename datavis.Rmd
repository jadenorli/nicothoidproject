---
title: "DataVis"
output: html_document
date: "2023-01-20"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(RColorBrewer)
library(caret)
source("my_functions.R")
setup_libs()

display.brewer.all(colorblindFriendly = TRUE)
```

#1.Egg Mort Data 

Looking at egg mortality from winter 2023
- 9 crabs
- egg dev varied from G to spawn
- we think that number of adult nicos will directly affect egg mortality
```{r visualize egg mortality data}
eggs <- read_csv("NicothoidProjectAnalysis/RawData/eggmortality_w2023.csv") %>% 
  clean_names() %>% 
  select(!16:27) %>% 
  mutate(prop_viable_eggs = number_viable_crab_eggs/total_number_crab_eggs) %>% 
  mutate(prop_nonviable = total_number_non_viable_crab_eggs/total_number_crab_eggs)

nico_v_eggs <- ggplot(data = eggs, aes(x = number_adult_nicos, y = prop_viable_eggs)) +
  geom_point()

nico_v_nveggs <- ggplot(data = eggs, aes(x = number_adult_nicos, y = prop_nonviable)) +
  geom_point()
```


```{r, visualize full first trial of egg mort data}
#create an eggs_mort_all dataframe with columns for the prop of the values at that time
eggs_mort_all <- read_csv("NicothoidProjectAnalysis/RawData/LifeCycleExport2.csv")%>% 
  clean_names() %>%
  select(!16:27) %>% 
  filter(!is.na(pleopod_number)) %>%
  filter(!eds == "M") %>%
  mutate_at(c(6:15), as.numeric) %>%
  mutate(prop_viable_eggs = number_viable_crab_eggs/total_number_crab_eggs) %>% 
  mutate(prop_nonviable_eggs = total_number_non_viable_crab_eggs/total_number_crab_eggs)%>%
  mutate(prop_damaged_eggs = number_damaged_crab_eggs/total_number_crab_eggs) %>%
  mutate(prop_stunted_eggs = number_stunted_crab_eggs/total_number_crab_eggs)%>%
  mutate(prop_adult_nicos = number_adult_nicos/total_number_crab_eggs) %>%
  mutate(prop_juvenile_nicos = number_juvenile_nicos/total_number_crab_eggs) %>%
  mutate(prop_nico_eggs = number_nico_eggs/total_number_crab_eggs)

#create a data frame with the average values across each EDS 
eggs_mort_avg <- eggs_mort_all %>%
  group_by(eds) %>%
  summarize(avg_prop_viable_eggs = mean(prop_viable_eggs),
            avg_prop_nonviable_eggs = mean(prop_nonviable_eggs),
            avg_prop_damaged_eggs = mean(prop_damaged_eggs),
            avg_prop_stunted_eggs = mean(prop_stunted_eggs),
            avg_prop_adult_nicos = mean(prop_adult_nicos),
            avg_prop_juvenile_nicos = mean(prop_juvenile_nicos),
            avg_prop_nico_eggs = mean(prop_nico_eggs)) %>% 
  as_tibble()

#create a normalized version of that dataframe
eggs_mort_process <- eggs_mort_avg %>%
  preProcess(method = c("range"))

eggs_mort_norm <- predict(eggs_mort_process, as_data_frame(eggs_mort_avg)) %>%
  filter(!is.na(avg_prop_viable_eggs)) %>%
  as_data_frame() 

#pivot the data longer 
eggs_mort_long <- eggs_mort_norm %>%
  pivot_longer(names_to = "averages",
               cols = c("avg_prop_viable_eggs" : "avg_prop_nico_eggs"))


#plot the data for the longer dataframe with the averages as groups
eggs_mort_vis <- ggplot(data = eggs_mort_long, 
       aes(x = eds, y = value, group = averages, col = averages)) +
  scale_fill_brewer(palette = "Paired",
                     name = "Legend") +
  geom_point() +
  geom_line() +
  theme_gray() +
  ylab("Average Proportion") +
  xlab("Egg Development Stage") + 
  ggtitle("Egg Mortality Across Egg Development Stages") +
  theme(plot.title = element_text(hjust = 0.5))

eggs_mort_vis
```
#2.Autoinfection Data 

##2.a) Visualize All
```{r, visualize autoinfeciton data}
#create an autoinfection_all dataframe with columns for the prop of the values at that time
autoinfection_all <- read_csv("NicothoidProjectAnalysis/RawData/autoinfection_all.csv") %>%
  clean_names()  %>% 
  mutate(prop_viable_eggs = number_viable_crab_eggs/total_number_crab_eggs) %>% 
  mutate(prop_nonviable_eggs = number_nonviable_crab_eggs/total_number_crab_eggs) %>%
  mutate(prop_adult_copepods = number_adult_copepods/total_number_crab_eggs) %>%
  mutate(prop_copepod_eggs = number_copepod_eggs/total_number_crab_eggs)

#create a data frame with the average values across each EDS 
autoinfection_avg <- autoinfection_all %>%
  group_by(egg_development_stage) %>%
  summarize(avg_prop_nonviable_eggs = mean(prop_nonviable_eggs),
            avg_prop_viable_eggs = mean(prop_viable_eggs),
            avg_prop_adult_copepods = mean(prop_adult_copepods),
            avg_prop_copepod_eggs = mean(prop_copepod_eggs)) %>%
  as_data_frame()

#create a standardized version of that dataframe by standard deviation 
##not sure if this is the best way to do this -- I also have the code for if we normalize around zero but this should show outliers better?
autoinfection_standard <- autoinfection_avg %>%
  mutate(stand_avg_prop_nonviable_eggs = scale(avg_prop_nonviable_eggs)) %>% 
  mutate(stand_avg_prop_viable_eggs = scale(avg_prop_viable_eggs)) %>%
  mutate(stand_avg_prop_adult_copepods = scale(avg_prop_adult_copepods)) %>%
  mutate(stand_avg_prop_copepod_eggs = scale(avg_prop_copepod_eggs))


autoinfection_norm <- autoinfection_standard %>%
  select(1, 6:9)

#pivot the data longer 
autoinfection_long <- autoinfection_norm %>%
  pivot_longer(names_to = "averages",
               cols = c("stand_avg_prop_nonviable_eggs" : "stand_avg_prop_copepod_eggs"))

as.numeric(autoinfection_long$averages)

#create a good color palette
nico_colors <- brewer.pal(n = 9, name = "OrRd")


#plot the data for the longer dataframe with the averages as groups
autoinfection_vis <- ggplot(data = auotinfection_long, 
       aes(x = egg_development_stage, y = value, group = averages, col = averages)) +
  scale_color_manual(values = c("#FDD49E","#EF6548","#B30000", "#7F0000"),
                     labels = c("Adult Copepods", "Copepod Eggs", "Nonviable Eggs", "Viable Eggs" ),
                     name = "Legend") +
  geom_point() +
  geom_line() +
  theme_gray() +
  ylab("Average Proportion") +
  xlab("Egg Development Stage") + 
  ggtitle("Autoinfection Across Egg Development Stages") +
  theme(plot.title = element_text(hjust = 0.5))

autoinfection_vis

```

##2.b) Visualize by Crab
```{r}

#create a data frame with the crab IDs in groups 
autoinfection_group <- autoinfection_all %>%
  group_by(crab_id) %>%
  summarize(avg_prop_nonviable_eggs = mean(prop_nonviable_eggs),
            avg_prop_viable_eggs = mean(prop_viable_eggs),
            avg_prop_adult_copepods = mean(prop_adult_copepods),
            avg_prop_copepod_eggs = mean(prop_copepod_eggs)) %>%
  as_tibble()

  # from jaden: The first thing I want to do is plot the values by crab so I need to make a wide data frame then group by crab then group by EDS and average across EDS per crab to compare the per crab data to the average of all 
  # zoe added onto this code to group first by INDIVIDUAL CRAB and then by EDS

autoinfection_crabmeans <- autoinfection_all %>%
  group_by(crab_id, egg_development_stage) %>%
  summarize(avg_prop_nonviable_eggs = mean(prop_nonviable_eggs),
            avg_prop_viable_eggs = mean(prop_viable_eggs),
            avg_prop_adult_copepods = mean(prop_adult_copepods),
            avg_prop_copepod_eggs = mean(prop_copepod_eggs), 
            .groups = 'drop')

autoinfection_crabmeans


#plotting means by individual creab
crab_vis <- ggplot(data = autoinfection_crabmeans, 
       aes(x = egg_development_stage, y = avg_prop_viable_eggs, 
           group = 1 ,     # necessary if we don't actually group
           col = "#7F0000"
           #, group = crab_id # this is one way to do it, but decided instead to facet so we can see each indiv crab
           )) + 
  geom_point() +
  geom_line() +
  geom_point(aes(y = avg_prop_nonviable_eggs, col = "#B30000")) +
  geom_line(aes(y = avg_prop_nonviable_eggs, col = "#B30000")) +
  geom_point(aes(y = avg_prop_adult_copepods, col = "#FDD49E")) +
  geom_line(aes(y = avg_prop_adult_copepods, col = "#FDD49E")) +
  geom_point(aes(y = avg_prop_copepod_eggs, col = "#EF6548")) +
  geom_line(aes(y = avg_prop_copepod_eggs, col = "#EF6548")) +
  facet_wrap(vars(crab_id)) +
  scale_color_manual(values = c("#FDD49E","#EF6548","#B30000", "#7F0000"),
                     labels = c("Adult Copepods", "Copepod Eggs", "Nonviable Eggs", "Viable Eggs" ),
                     name = "Legend") +
  theme_gray() +
  ylab("Average Proportion") +
  xlab("Egg Development Stage") + 
  ggtitle("Autoinfection Across Egg Development Stages") +
  theme(plot.title = element_text(hjust = 0.5))
```

